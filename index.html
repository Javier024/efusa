<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>EFUSA â€“ Dashboard Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- LibrerÃ­as Exportar -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <!-- Fuente -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Inter', sans-serif; }
    
    /* Animaciones */
    .fade-in { animation: fadeIn 0.6s ease-out forwards; opacity: 0; }
    .fade-in-delay-1 { animation-delay: 0.1s; }
    .fade-in-delay-2 { animation-delay: 0.2s; }
    .fade-in-delay-3 { animation-delay: 0.3s; }
    
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>

<body class="bg-gray-50 min-h-screen text-gray-800">

  <!-- Header -->
  <header class="bg-white border-b border-gray-200 sticky top-0 z-50">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
      <div class="flex items-center gap-3">
        <div class="bg-green-600 text-white p-2 rounded-xl shadow-lg shadow-green-200">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
          </svg>
        </div>
        <div>
          <h1 class="text-xl font-bold tracking-tight text-gray-900">EFUSA</h1>
          <p class="text-xs text-gray-500">Panel de Control</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <div class="text-right hidden sm:block">
          <p class="text-xs text-gray-400">Usuario</p>
          <p class="text-sm font-bold text-gray-700">Administrador</p>
        </div>
        <div class="h-10 w-10 rounded-full bg-gray-200 border border-white shadow-sm overflow-hidden">
          <img src="https://ui-avatars.com/api/?name=Admin&background=0D9488&color=fff" alt="Admin" />
        </div>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 py-8">

    <!-- KPIs -->
    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 fade-in">
      
      <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
        <div class="flex justify-between items-start">
          <div><p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Jugadores</p><h3 class="text-3xl font-bold text-gray-900 mt-2" id="total-jugadores">0</h3></div>
          <div class="p-3 bg-blue-50 text-blue-600 rounded-xl"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0z"></path></svg></div>
        </div>
        <div class="mt-4 text-xs text-green-600 flex items-center font-medium"><svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg> Activos</div>
      </div>

      <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
        <div class="flex justify-between items-start">
          <div><p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Ingresos Mes</p><h3 class="text-3xl font-bold text-green-600 mt-2" id="pagos-mes">$0</h3></div>
          <div class="p-3 bg-green-50 text-green-600 rounded-xl"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
        </div>
        <div class="mt-4 text-xs text-gray-500">RecaudaciÃ³n actual</div>
      </div>

      <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
        <div class="flex justify-between items-start">
          <div><p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Morosos</p><h3 class="text-3xl font-bold text-red-600 mt-2" id="morosos">0</h3></div>
          <div class="p-3 bg-red-50 text-red-600 rounded-xl"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg></div>
        </div>
        <div class="mt-4 text-xs text-gray-500">Pendientes este mes</div>
      </div>

      <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
        <div class="flex justify-between items-start">
          <div><p class="text-xs font-bold text-gray-400 uppercase tracking-wider">CategorÃ­as</p><h3 class="text-3xl font-bold text-purple-600 mt-2">4</h3></div>
          <div class="p-3 bg-purple-50 text-purple-600 rounded-xl"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg></div>
        </div>
        <div class="mt-4 text-xs text-gray-500">Activas en sistema</div>
      </div>
    </section>

    <!-- GrÃ¡fica y Goleadores -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
      
      <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 lg:col-span-2 fade-in fade-in-delay-1">
        <div class="flex justify-between items-center mb-6">
          <h3 class="font-bold text-gray-800">Historial de Ingresos</h3>
          <select class="text-xs border-gray-200 border rounded-lg px-2 py-1 text-gray-500 bg-gray-50 outline-none"><option>Ãšltimos 6 meses</option></select>
        </div>
        <div class="relative h-64 w-full"><canvas id="ingresosChart"></canvas></div>
      </div>

      <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 fade-in fade-in-delay-2">
        <div class="flex items-center gap-2 mb-6">
          <div class="p-2 bg-yellow-100 text-yellow-600 rounded-lg"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg></div>
          <h3 class="font-bold text-gray-800">Top Goleadores</h3>
        </div>
        <div id="goleadores-list" class="space-y-4"></div>
      </div>
    </div>

    <!-- TABLAS CON PAGINACIÃ“N -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">

      <!-- TABLA VENCIMIENTOS (Actualizada) -->
      <section class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden flex flex-col fade-in fade-in-delay-3">
        <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50">
          <h3 class="font-bold text-gray-700 flex items-center gap-2"><span class="text-lg">ðŸ“…</span> Estado de Pagos</h3>
          <div class="flex gap-2">
            <button onclick="exportTableToExcel('tabla-vencimientos', 'estado_pagos_efusa')" class="text-xs bg-white border border-gray-200 text-gray-600 px-3 py-1.5 rounded-lg hover:bg-green-50 hover:text-green-600 hover:border-green-200 transition font-medium shadow-sm">Excel</button>
            <button onclick="exportTableToPDF('tabla-vencimientos', 'estado_pagos_efusa')" class="text-xs bg-white border border-gray-200 text-gray-600 px-3 py-1.5 rounded-lg hover:bg-red-50 hover:text-red-600 hover:border-red-200 transition font-medium shadow-sm">PDF</button>
          </div>
        </div>
        
        <div class="overflow-x-auto">
          <table class="w-full text-sm text-left" id="tabla-vencimientos">
            <thead class="bg-gray-100 text-gray-600 uppercase text-xs font-bold">
              <tr>
                <th class="px-6 py-3">Jugador</th>
                <th class="px-6 py-3">CategorÃ­a</th>
                <th class="px-6 py-3">Estado</th>
              </tr>
            </thead>
            <tbody id="body-vencimientos" class="divide-y divide-gray-100"></tbody>
          </table>
        </div>

        <!-- PaginaciÃ³n Vencimientos -->
        <div class="p-4 border-t border-gray-100 bg-gray-50 flex justify-between items-center text-sm">
          <span class="text-gray-500" id="info-paginacion-venc">Mostrando 0-0 de 0</span>
          <div class="flex gap-2">
            <button id="btn-prev-venc" onclick="cambiarPaginaVenc(-1)" class="px-3 py-1 border rounded hover:bg-gray-200 disabled:opacity-50">Anterior</button>
            <span id="pagina-actual-venc" class="px-3 py-1 font-bold bg-white border rounded">1</span>
            <button id="btn-next-venc" onclick="cambiarPaginaVenc(1)" class="px-3 py-1 border rounded hover:bg-gray-200 disabled:opacity-50">Siguiente</button>
          </div>
        </div>
      </section>

      <!-- TABLA MOVIMIENTOS -->
      <section class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden flex flex-col fade-in fade-in-delay-3">
        <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50">
          <h3 class="font-bold text-gray-700 flex items-center gap-2"><span class="text-lg">ðŸ•’</span> Ãšltimos Pagos</h3>
          <div class="flex gap-2">
            <button onclick="exportTableToExcel('tabla-movimientos', 'movimientos_efusa')" class="text-xs bg-white border border-gray-200 text-gray-600 px-3 py-1.5 rounded-lg hover:bg-green-50 hover:text-green-600 hover:border-green-200 transition font-medium shadow-sm">Excel</button>
            <button onclick="exportTableToPDF('tabla-movimientos', 'movimientos_efusa')" class="text-xs bg-white border border-gray-200 text-gray-600 px-3 py-1.5 rounded-lg hover:bg-red-50 hover:text-red-600 hover:border-red-200 transition font-medium shadow-sm">PDF</button>
          </div>
        </div>

        <div class="overflow-x-auto">
          <table class="w-full text-sm text-left" id="tabla-movimientos">
            <thead class="bg-gray-100 text-gray-600 uppercase text-xs font-bold">
              <tr>
                <th class="px-6 py-3">Fecha</th>
                <th class="px-6 py-3">Jugador</th>
                <th class="px-6 py-3">Monto</th>
                <th class="px-6 py-3">Tipo</th>
              </tr>
            </thead>
            <tbody id="body-movimientos" class="divide-y divide-gray-100"></tbody>
          </table>
        </div>

        <!-- PaginaciÃ³n Movimientos -->
        <div class="p-4 border-t border-gray-100 bg-gray-50 flex justify-between items-center text-sm">
          <span class="text-gray-500" id="info-paginacion-mov">Mostrando 0-0 de 0</span>
          <div class="flex gap-2">
            <button id="btn-prev-mov" onclick="cambiarPaginaMov(-1)" class="px-3 py-1 border rounded hover:bg-gray-200 disabled:opacity-50">Anterior</button>
            <span id="pagina-actual-mov" class="px-3 py-1 font-bold bg-white border rounded">1</span>
            <button id="btn-next-mov" onclick="cambiarPaginaMov(1)" class="px-3 py-1 border rounded hover:bg-gray-200 disabled:opacity-50">Siguiente</button>
          </div>
        </div>
      </section>

    </div>

    <!-- Accesos RÃ¡pidos -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-6 fade-in fade-in-delay-3">
      <a href="jugadores.html" class="group bg-gradient-to-br from-blue-50 to-white p-6 rounded-2xl shadow-sm hover:shadow-xl transition border border-blue-100 flex items-center gap-4"><div class="p-3 bg-white text-blue-600 rounded-xl shadow-sm group-hover:scale-110 transition-transform duration-300"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg></div><div><h3 class="font-bold text-gray-800">GestiÃ³n Jugadores</h3><p class="text-xs text-gray-500 mt-1">Fichas y EstadÃ­sticas</p></div></a>
      <a href="pagos.html" class="group bg-gradient-to-br from-green-50 to-white p-6 rounded-2xl shadow-sm hover:shadow-xl transition border border-green-100 flex items-center gap-4"><div class="p-3 bg-white text-green-600 rounded-xl shadow-sm group-hover:scale-110 transition-transform duration-300"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg></div><div><h3 class="font-bold text-gray-800">Caja y Pagos</h3><p class="text-xs text-gray-500 mt-1">Registrar ingresos</p></div></a>
      <a href="alertas.html" class="group bg-gradient-to-br from-red-50 to-white p-6 rounded-2xl shadow-sm hover:shadow-xl transition border border-red-100 flex items-center gap-4"><div class="p-3 bg-white text-red-600 rounded-xl shadow-sm group-hover:scale-110 transition-transform duration-300"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg></div><div><h3 class="font-bold text-gray-800">Alertas y Deudas</h3><p class="text-xs text-gray-500 mt-1">Cartera vencida</p></div></a>
    </section>

  </main>

  <!-- LOGICA JAVASCRIPT -->
  <script>
    // ConfiguraciÃ³n
    const formatMoney = (amount) => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(amount);
    const formatDate = (dateString) => {
      if (!dateString) return '-';
      const options = { year: 'numeric', month: 'short', day: 'numeric' };
      return new Date(dateString).toLocaleDateString('es-ES', options);
    };

    // --- EXPORTACIÃ“N ---
    window.exportTableToExcel = function(tableId, filename = ''){
      const table = document.getElementById(tableId);
      const wb = XLSX.utils.table_to_book(table, {sheet: "Hoja 1"});
      XLSX.writeFile(wb, filename + '.xlsx');
    }

    window.exportTableToPDF = function(tableId, filename = ''){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("Reporte EFUSA", 14, 15);
      doc.autoTable({ html: '#' + tableId, startY: 20, theme: 'grid', headStyles: { fillColor: [22, 163, 74] } });
      doc.save(filename + '.pdf');
    }

    // --- GRÃFICA ---
    let chartInstance = null;
    function renderChart(pagos) {
      const ctx = document.getElementById('ingresosChart').getContext('2d');
      const meses = [];
      const montos = [];
      for (let i = 5; i >= 0; i--) {
        const d = new Date();
        d.setMonth(d.getMonth() - i);
        const mesNombre = d.toLocaleString('es-ES', { month: 'short' });
        meses.push(mesNombre.charAt(0).toUpperCase() + mesNombre.slice(1));
        const totalMes = pagos.filter(p => { const fp = new Date(p.fecha_pago); return fp.getMonth() === d.getMonth() && fp.getFullYear() === d.getFullYear(); }).reduce((acc, curr) => acc + parseFloat(curr.monto), 0);
        montos.push(totalMes);
      }
      if (chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctx, { type: 'line', data: { labels: meses, datasets: [{ label: 'Ingresos ($)', data: montos, borderColor: '#16a34a', backgroundColor: 'rgba(22, 163, 74, 0.1)', borderWidth: 2, fill: true, tension: 0.4, pointRadius: 4, pointBackgroundColor: '#16a34a' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: '#f3f4f6' } }, x: { grid: { display: false } } } } });
    }

    // ==========================================
    // VARIABLES GLOBALES (CORRECCIÃ“N CRÃTICA)
    // ==========================================
    // Estas variables se declaran AQUÃ FUERA para que todas las funciones puedan verlas
    let jugadores = []; 
    let pagos = []; 

    // --- ESTADO PAGINACIÃ“N ---
    // Vencimientos
    let listaVencimientos = [];
    let pagActualVenc = 1;
    const filasPorPagina = 10;

    // Movimientos
    let listaMovimientos = [];
    let pagActualMov = 1;

    // --- INICIO ---
    async function initDashboard() {
      try {
        const [resPagos, resJugadores] = await Promise.all([fetch('/api/pagos'), fetch('/api/jugadores')]);
        if (!resPagos.ok || !resJugadores.ok) throw new Error("Error conectando API");
        
        // ==========================================
        // ASIGNACIÃ“N A GLOBALES (CORRECCIÃ“N CRÃTICA)
        // ==========================================
        // Quitamos 'const' para asignar a las variables globales definidas arriba
        pagos = await resPagos.json();
        jugadores = await resJugadores.json();

        renderKPIs(jugadores, pagos);
        renderChart(pagos);
        renderGoleadores(jugadores);
        
        // Preparar listas con lÃ³gica
        prepararVencimientos(jugadores, pagos);
        prepararMovimientos(pagos, jugadores);

        // Renderizar tablas iniciales
        renderTablaVencimientos();
        renderTablaMovimientos();

      } catch (error) { console.error(error); alert("Hubo un error cargando los datos."); }
    }

    function renderKPIs(jugadores, pagos) {
      animateValue("total-jugadores", 0, jugadores.length, 1000);
      const hoy = new Date();
      const ingresos = pagos.reduce((sum, p) => { const f = new Date(p.fecha_pago); if (f.getMonth() === hoy.getMonth() && f.getFullYear() === hoy.getFullYear()) return sum + parseFloat(p.monto); return sum; }, 0);
      document.getElementById('pagos-mes').innerText = formatMoney(ingresos);

      const idsPagadores = new Set(pagos.filter(p => { const f = new Date(p.fecha_pago); return f.getMonth() === hoy.getMonth() && f.getFullYear() === hoy.getFullYear(); }).map(p => p.jugador_id));
      const morososCount = jugadores.filter(j => !idsPagadores.has(j.id)).length;
      document.getElementById('morosos').innerText = morososCount;
    }

    function renderGoleadores(jugadores) {
      const container = document.getElementById('goleadores-list');
      container.innerHTML = '';
      const goleadores = jugadores.filter(j => j.goles > 0).sort((a, b) => b.goles - a.goles).slice(0, 5);
      if (goleadores.length === 0) { container.innerHTML = `<div class="text-center text-gray-400 py-8 text-sm">No hay goles registrados aÃºn.</div>`; return; }
      const maxGoles = goleadores[0].goles;
      goleadores.forEach((j, index) => {
        const percent = (j.goles / maxGoles) * 100;
        let iconColor = 'text-gray-400';
        if (index === 0) iconColor = 'text-yellow-500'; 
        if (index === 1) iconColor = 'text-gray-400'; 
        if (index === 2) iconColor = 'text-orange-700';
        container.insertAdjacentHTML('beforeend', `<div class="flex items-center gap-3"><div class="flex flex-col items-center justify-center w-8"><span class="font-bold text-xs ${iconColor}">${index + 1}</span></div><div class="flex-1"><div class="flex justify-between items-center mb-1"><h4 class="text-sm font-bold text-gray-800 truncate pr-2">${j.nombre}</h4><span class="text-sm font-bold text-green-600">${j.goles} <span class="text-xs text-gray-400 font-normal">goles</span></span></div><div class="w-full h-2 bg-gray-100 rounded-full overflow-hidden"><div class="h-full bg-green-500 transition-all duration-500" style="width: ${percent}%"></div></div></div></div>`);
      });
    }

    // --- LÃ“GICA VENCIMIENTOS (ESTADO DE PAGO) ---
    function prepararVencimientos(jugadores, pagos) {
      // Calculamos "vencimiento" para ordenar, pero mostramos el estado del jugador
      listaVencimientos = jugadores.map(j => {
        const pagosJugador = pagos.filter(p => p.jugador_id == j.id);
        let ultimoPagoDate = null;
        if (pagosJugador.length > 0) {
          pagosJugador.sort((a, b) => new Date(b.fecha_pago) - new Date(a.fecha_pago));
          ultimoPagoDate = new Date(pagosJugador[0].fecha_pago);
        } else {
          ultimoPagoDate = new Date();
          ultimoPagoDate.setDate(ultimoPagoDate.getDate() - 30);
        }
        // Fecha de referencia para ordenar (Ãºltimo pago + 30)
        const refDate = new Date(ultimoPagoDate);
        refDate.setDate(refDate.getDate() + 30);
        return { ...j, refDate };
      }).sort((a, b) => a.refDate - b.refDate); // Ordenar por fecha teÃ³rica de pago
    }

    function getEstadoBadge(estado, pagoEsteMes) {
      // Prioridad: Campo estado_pago -> CÃ¡lculo automÃ¡tico
      if (estado === 'Pagado') return `<span class="px-2 py-1 text-xs rounded-full bg-green-50 text-green-600 font-bold border border-green-200">Pagado</span>`;
      if (estado === 'Abono') return `<span class="px-2 py-1 text-xs rounded-full bg-yellow-50 text-yellow-700 font-bold border border-yellow-200">Abono</span>`;
      if (estado === 'Pendiente') return `<span class="px-2 py-1 text-xs rounded-full bg-red-50 text-red-600 font-bold border border-red-200">Pendiente</span>`;
      
      // Si no hay estado definido, calculamos
      if (pagoEsteMes) return `<span class="px-2 py-1 text-xs rounded-full bg-green-50 text-green-600 font-bold border border-green-200">Pagado</span>`;
      return `<span class="px-2 py-1 text-xs rounded-full bg-red-50 text-red-600 font-bold border border-red-200">Pendiente</span>`;
    }

    function renderTablaVencimientos() {
      const tbody = document.getElementById('body-vencimientos');
      tbody.innerHTML = '';

      if (listaVencimientos.length === 0) {
        tbody.innerHTML = `<tr><td colspan="3" class="p-8 text-center text-gray-400">No hay jugadores.</td></tr>`;
        actualizarPaginacionVenc(0);
        return;
      }

      const inicio = (pagActualVenc - 1) * filasPorPagina;
      const fin = inicio + filasPorPagina;
      const datosPagina = listaVencimientos.slice(inicio, fin);

      // Verificar mes actual para cÃ¡lculo automÃ¡tico si faltan datos
      const hoy = new Date();
      const mesActual = hoy.getMonth();
      const anioActual = hoy.getFullYear();

      datosPagina.forEach(j => {
        // Chequear si pagÃ³ este mes para cÃ¡lculo automÃ¡tico
        const pagosEsteMes = j.pagos ? j.pagos.some(p => { const f = new Date(p.fecha_pago); return f.getMonth() === mesActual && f.getFullYear() === anioActual; }) : false;
        const badge = getEstadoBadge(j.estado_pago, pagosEsteMes);

        tbody.innerHTML += `
          <tr class="hover:bg-gray-50 transition-colors">
            <td class="px-6 py-4 font-medium text-gray-900">${j.nombre}</td>
            <td class="px-6 py-4 text-gray-500 text-xs">${j.categoria || 'N/A'}</td>
            <td class="px-6 py-4 text-center">${badge}</td>
          </tr>
        `;
      });
      actualizarPaginacionVenc(listaVencimientos.length);
    }

    window.cambiarPaginaVenc = (delta) => {
      const maxPag = Math.ceil(listaVencimientos.length / filasPorPagina);
      const nuevaPag = pagActualVenc + delta;
      if (nuevaPag >= 1 && nuevaPag <= maxPag) { pagActualVenc = nuevaPag; renderTablaVencimientos(); }
    };

    function actualizarPaginacionVenc(totalItems) {
      const maxPag = Math.ceil(totalItems / filasPorPagina) || 1;
      const inicio = totalItems > 0 ? (pagActualVenc - 1) * filasPorPagina + 1 : 0;
      const fin = Math.min(pagActualVenc * filasPorPagina, totalItems);
      document.getElementById('pagina-actual-venc').innerText = `${pagActualVenc} / ${maxPag}`;
      document.getElementById('info-paginacion-venc').innerText = `Mostrando ${inicio}-${fin} de ${totalItems}`;
      document.getElementById('btn-prev-venc').disabled = pagActualVenc === 1;
      document.getElementById('btn-next-venc').disabled = pagActualVenc === maxPag;
    }

    // --- LÃ“GICA MOVIMIENTOS ---
    function prepararMovimientos(pagos, jugadores) {
      listaMovimientos = [...pagos].sort((a, b) => new Date(b.fecha_pago) - new Date(a.fecha_pago));
    }

    function renderTablaMovimientos() {
      const tbody = document.getElementById('body-movimientos');
      tbody.innerHTML = '';
      if (listaMovimientos.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" class="p-8 text-center text-gray-400">No hay pagos.</td></tr>`;
        actualizarPaginacionMov(0);
        return;
      }
      const inicio = (pagActualMov - 1) * filasPorPagina;
      const fin = inicio + filasPorPagina;
      const datosPagina = listaMovimientos.slice(inicio, fin);
      datosPagina.forEach(p => {
        // Gracias a que 'jugadores' es global, esto ya no darÃ¡ error
        const jugador = jugadores.find(j => j.id == p.jugador_id);
        const nombre = jugador ? jugador.nombre : 'Desconocido';
        tbody.innerHTML += `<tr class="hover:bg-gray-50 transition-colors"><td class="px-6 py-4 text-gray-500 text-xs">${formatDate(p.fecha_pago)}</td><td class="px-6 py-4 font-medium text-gray-900">${nombre}</td><td class="px-6 py-4 font-bold text-green-600">${formatMoney(p.monto)}</td><td class="px-6 py-4"><span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-[10px] uppercase font-bold tracking-wide">${p.tipo || 'Abono'}</span></td></tr>`;
      });
      actualizarPaginacionMov(listaMovimientos.length);
    }

    window.cambiarPaginaMov = (delta) => {
      const maxPag = Math.ceil(listaMovimientos.length / filasPorPagina);
      const nuevaPag = pagActualMov + delta;
      if (nuevaPag >= 1 && nuevaPag <= maxPag) { pagActualMov = nuevaPag; renderTablaMovimientos(); }
    };

    function actualizarPaginacionMov(totalItems) {
      const maxPag = Math.ceil(totalItems / filasPorPagina) || 1;
      const inicio = totalItems > 0 ? (pagActualMov - 1) * filasPorPagina + 1 : 0;
      const fin = Math.min(pagActualMov * filasPorPagina, totalItems);
      document.getElementById('pagina-actual-mov').innerText = `${pagActualMov} / ${maxPag}`;
      document.getElementById('info-paginacion-mov').innerText = `Mostrando ${inicio}-${fin} de ${totalItems}`;
      document.getElementById('btn-prev-mov').disabled = pagActualMov === 1;
      document.getElementById('btn-next-mov').disabled = pagActualMov === maxPag;
    }

    function animateValue(id, start, end, duration) {
      const obj = document.getElementById(id); let startTimestamp = null;
      const step = (timestamp) => {
        if (!startTimestamp) startTimestamp = timestamp;
        const progress = Math.min((timestamp - startTimestamp) / duration, 1);
        obj.innerHTML = Math.floor(progress * (end - start) + start);
        if (progress < 1) window.requestAnimationFrame(step);
      };
      window.requestAnimationFrame(step);
    }

    document.addEventListener('DOMContentLoaded', initDashboard);
  </script>
</body>
</html>