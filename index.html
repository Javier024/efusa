<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>EFUSA â€“ Dashboard Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
  </style>
</head>

<body class="bg-gray-50 min-h-screen text-gray-800">

<!-- HEADER (sin cambios visuales) -->
<!-- â€¦ TU HEADER ORIGINAL SE MANTIENE â€¦ -->

<main class="container mx-auto px-4 py-8">

<!-- ================== TODO TU HTML VISUAL ORIGINAL ================== -->
<!-- KPIs, tablas, accesos rÃ¡pidos, etc -->
<!-- NO SE MODIFICA NADA DEL MARKUP -->
<!-- ================================================================ -->

</main>

<script>
/* ================= CONFIG ================= */
const API_URL = './api'; // ðŸ”§ CAMBIAR AQUÃ SI USAS OTRO HOST
const formatMoney = v => new Intl.NumberFormat('es-CO',{style:'currency',currency:'COP',minimumFractionDigits:0}).format(v);
const formatDate = f => f ? new Date(f).toLocaleDateString('es-ES',{day:'numeric',month:'short',year:'numeric'}) : '-';

/* ================= EXPORT ================= */
window.exportTableToExcel = (id,name='reporte')=>{
  const wb = XLSX.utils.table_to_book(document.getElementById(id),{sheet:'EFUSA'});
  XLSX.writeFile(wb,`${name}.xlsx`);
};
window.exportTableToPDF = (id,name='reporte')=>{
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  pdf.text('Reporte EFUSA',14,15);
  pdf.autoTable({ html:'#'+id,startY:20,theme:'grid' });
  pdf.save(`${name}.pdf`);
};

/* ================= DATA ================= */
let jugadores = [];
let pagos = [];
let listaVencimientos = [];
let listaMovimientos = [];
let pagVenc = 1;
let pagMov = 1;
const filas = 10;

/* ================= INIT ================= */
async function initDashboard(){
  try{
    const [pj,pjgs] = await Promise.all([
      fetch(`${API_URL}/pagos`).then(r=>r.json()),
      fetch(`${API_URL}/jugadores`).then(r=>r.json())
    ]);

    pagos = pj || [];
    jugadores = pjgs || [];

    renderKPIs();
    renderChart();
    renderGoleadores();
    prepararVencimientos();
    prepararMovimientos();
    renderTablaVencimientos();
    renderTablaMovimientos();
  }catch(e){
    console.error(e);
    alert('Error cargando datos');
  }
}

/* ================= KPIs ================= */
function renderKPIs(){
  document.getElementById('total-jugadores').innerText = jugadores.length;
  const hoy = new Date();
  const total = pagos.reduce((s,p)=>{
    const f = new Date(p.fecha_pago);
    return (f.getMonth()===hoy.getMonth() && f.getFullYear()===hoy.getFullYear())
      ? s + Number(p.monto||0) : s;
  },0);
  document.getElementById('pagos-mes').innerText = formatMoney(total);

  const pagaron = new Set(pagos.map(p=>p.jugador_id));
  document.getElementById('morosos').innerText = jugadores.filter(j=>!pagaron.has(j.id)).length;
}

/* ================= CHART ================= */
function renderChart(){
  const canvas = document.getElementById('ingresosChart');
  if(!canvas) return;

  const meses=[], montos=[];
  for(let i=5;i>=0;i--){
    const d=new Date(); d.setMonth(d.getMonth()-i);
    meses.push(d.toLocaleString('es',{month:'short'}));
    montos.push(
      pagos.filter(p=>{
        const f=new Date(p.fecha_pago);
        return f.getMonth()===d.getMonth() && f.getFullYear()===d.getFullYear();
      }).reduce((s,p)=>s+Number(p.monto||0),0)
    );
  }
  new Chart(canvas,{
    type:'line',
    data:{labels:meses,datasets:[{data:montos,borderColor:'#16a34a',fill:true}]},
    options:{plugins:{legend:{display:false}}}
  });
}

/* ================= GOLEADORES ================= */
function renderGoleadores(){
  const c=document.getElementById('goleadores-list');
  c.innerHTML='';
  const top=[...jugadores].filter(j=>j.goles>0).sort((a,b)=>b.goles-a.goles).slice(0,5);
  if(!top.length){c.innerHTML='<p class="text-sm text-gray-400">Sin datos</p>';return;}
  top.forEach(j=>{
    c.innerHTML+=`<div class="flex justify-between"><span>${j.nombre}</span><b>${j.goles}</b></div>`;
  });
}

/* ================= VENCIMIENTOS ================= */
function prepararVencimientos(){
  listaVencimientos = jugadores.map(j=>{
    const p = pagos.filter(x=>x.jugador_id==j.id).sort((a,b)=>new Date(b.fecha_pago)-new Date(a.fecha_pago));
    const ref = p[0]? new Date(p[0].fecha_pago):new Date(Date.now()-30*864e5);
    ref.setDate(ref.getDate()+30);
    return {...j,ref};
  }).sort((a,b)=>a.ref-b.ref);
  pagVenc=1;
}
function renderTablaVencimientos(){
  const tb=document.getElementById('body-vencimientos');
  tb.innerHTML='';
  const page=listaVencimientos.slice((pagVenc-1)*filas,pagVenc*filas);
  page.forEach(j=>{
    tb.innerHTML+=`<tr><td>${j.nombre}</td><td>${j.categoria||'-'}</td><td>OK</td></tr>`;
  });
}
window.cambiarPaginaVenc=d=>{pagVenc+=d;renderTablaVencimientos();};

/* ================= MOVIMIENTOS ================= */
function prepararMovimientos(){
  listaMovimientos=[...pagos].sort((a,b)=>new Date(b.fecha_pago)-new Date(a.fecha_pago));
  pagMov=1;
}
function renderTablaMovimientos(){
  const tb=document.getElementById('body-movimientos');
  tb.innerHTML='';
  listaMovimientos.slice((pagMov-1)*filas,pagMov*filas).forEach(p=>{
    const j=jugadores.find(x=>x.id==p.jugador_id);
    tb.innerHTML+=`<tr>
      <td>${formatDate(p.fecha_pago)}</td>
      <td>${j?.nombre||'â€”'}</td>
      <td>${formatMoney(p.monto)}</td>
      <td>${p.tipo||'Abono'}</td>
    </tr>`;
  });
}
window.cambiarPaginaMov=d=>{pagMov+=d;renderTablaMovimientos();};

document.addEventListener('DOMContentLoaded',initDashboard);
</script>

</body>
</html>
